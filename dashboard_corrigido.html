<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Omie - Movimento Financeiro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .performance-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .perf-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); }
        .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-card-title { font-size: 0.9rem; font-weight: 500; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card-icon { width: 24px; height: 24px; color: #667eea; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: #333; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: #888; }
        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #666;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e1e5e9;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filters-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .filters-title {
            font-size: 1rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filters-grid { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            color: #64748b;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .filter-btn.all {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-color: #059669;
            color: white;
            font-weight: 600;
        }
        .filter-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        .date-filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .date-input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            transition: border-color 0.2s ease;
        }
        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .clear-date-btn {
            padding: 8px 16px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .clear-date-btn:hover {
            background: #d97706;
            transform: translateY(-1px);
        }
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e1e5e9;
            max-height: 600px;
            overflow-y: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            background: #f8fafc;
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid #e1e5e9;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; }
        tbody tr:hover { background: #f8fafc; }
        .empresa-cell { font-weight: 600; color: #334155; }
        .conta-cell { color: #64748b; }
        .valor-positivo { color: #059669; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .valor-negativo { color: #dc2626; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .card-title { font-size: 1.5rem; font-weight: 600; color: #333; }
        .search-container { position: relative; flex: 1; max-width: 400px; }
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: #666;
        }
        .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); }
        .footer-info {
            margin-top: 20px;
            padding: 15px 20px;
            background: #f8fafc;
            border-radius: 12px;
            font-size: 0.9rem;
            color: #64748b;
            text-align: center;
        }
        .debug-info {
            margin-top: 10px;
            padding: 10px 15px;
            background: #d4edda;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            font-size: 0.85rem;
            color: #155724;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Configura√ß√£o Supabase
        const SUPABASE_URL = 'https://rjwfiapaklwtlqnesqag.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqd2ZpYXBha2x3dGxxbmVzcWFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MDE4MDQsImV4cCI6MjA3MjE3NzgwNH0.KStViLevYcJ6f9pBlqPbMIAkFr4FWpdp7uaKABGARo0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function DashboardOmie() {
            const [dados, setDados] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [busca, setBusca] = useState('');
            const [empresaSelecionada, setEmpresaSelecionada] = useState('TODAS');
            const [empresas, setEmpresas] = useState([]);
            const [dataFiltro, setDataFiltro] = useState('');
            const [stats, setStats] = useState({
                totalEmpresas: 0,
                totalCombinacoes: 0,
                somaTotal: 0
            });
            const [performance, setPerformance] = useState({
                tempoCarregamento: 0,
                metodo: 'view_saldo_acumulado',
                cacheAtualizado: null
            });

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            const formatNumber = (value) => {
                return new Intl.NumberFormat('pt-BR').format(value);
            };

            // ===============================================
            // NOVA FUN√á√ÉO: CARREGAR COM VIEW CORRETA
            // ===============================================
            const carregarDadosComFiltroData = async () => {
                const startTime = window.performance.now();
                try {
                    setLoading(true);
                    setError('');
                    // Carregando dados da view unificada
                    
                    let todosOsDados = [];
                    let offset = 0;
                    const limit = 1000; // Limite por p√°gina
                    let temMaisDados = true;

                    while (temMaisDados) {
                        let query = supabase
                            .from('vw_saldo_acumulado')
                            .select(`
                                empresa,
                                conta_corrente_descricao,
                                chave_empresa_cod_c_corrente,
                                d_dt_pagamento,
                                valor_corrigido,
                                tipo
                            `)
                            .range(offset, offset + limit - 1);

                        // Aplicar filtro de data se houver
                        if (dataFiltro) {
                            query = query.lte('d_dt_pagamento', dataFiltro);
                        }

                        // Aplicar filtro de empresa se n√£o for "TODAS"
                        if (empresaSelecionada && empresaSelecionada !== 'TODAS') {
                            query = query.eq('empresa', empresaSelecionada);
                        }

                        const { data: dadosPagina, error: errorView } = await query.order('d_dt_pagamento');
                        
                        if (errorView) throw errorView;
                        
                        // Carregando p√°gina de dados
                        
                        todosOsDados = [...todosOsDados, ...dadosPagina];
                        
                        // Se retornou menos que o limite, n√£o h√° mais dados
                        if (dadosPagina.length < limit) {
                            temMaisDados = false;
                        } else {
                            offset += limit;
                        }
                    }

                    const dadosView = todosOsDados;

                    // Dados carregados com sucesso

                    // AGRUPAR POR CONTA E CALCULAR SOMA ACUMULATIVA AT√â A DATA FILTRO
                    const contasPorChave = {};
                    
                    // Primeiro, agrupar todos os registros por conta
                    dadosView.forEach(item => {
                        const chave = `${item.empresa}|${item.conta_corrente_descricao}`;
                        
                        if (!contasPorChave[chave]) {
                            contasPorChave[chave] = {
                                empresa: item.empresa,
                                conta_corrente_descricao: item.conta_corrente_descricao,
                                registros: []
                            };
                        }
                        
                        contasPorChave[chave].registros.push({
                            data: item.d_dt_pagamento,
                            valor: parseFloat(item.valor_corrigido || 0),
                            tipo: item.tipo
                        });
                    });

                    // Calcular soma acumulativa para cada conta
                    const dadosProcessados = [];
                    
                    Object.values(contasPorChave).forEach(conta => {
                        // Ordenar registros por data
                        conta.registros.sort((a, b) => new Date(a.data) - new Date(b.data));
                        
                        let somaAcumulada = 0;
                        let qtdMovimentos = 0;
                        
                        // Somar todos os valores at√© a data filtro (inclusive)
                        conta.registros.forEach(registro => {
                            if (registro.data <= dataFiltro) {
                                somaAcumulada += registro.valor;
                                qtdMovimentos++;
                            }
                        });
                        
                        // Debug para conta espec√≠fica
                        if (conta.empresa === '3SA' && conta.conta_corrente_descricao === 'Cart√£o - Caixinha - RH') {
                            console.log('üîç DEBUG Cart√£o - Caixinha - RH:');
                            console.log('  - Registros encontrados:', conta.registros.length);
                            console.log('  - Registros at√© data filtro:', qtdMovimentos);
                            console.log('  - Soma acumulada:', somaAcumulada);
                            console.log('  - Detalhes:', conta.registros.filter(r => r.data <= dataFiltro));
                        }
                        
                        // Adicionar conta processada (se teve movimentos at√© a data ou se n√£o h√° filtro)
                        if (qtdMovimentos > 0 || !dataFiltro) {
                            dadosProcessados.push({
                                empresa: conta.empresa,
                                conta_corrente_descricao: conta.conta_corrente_descricao,
                                saldo_inicial: 0, // N√£o faz mais sentido separar
                                valor_corrigido: somaAcumulada,
                                qtd_movimentos: qtdMovimentos
                            });
                        }
                    });

                    console.log('üìä Dados processados:', dadosProcessados.length);

                    // LOG DE DEBUG para a conta espec√≠fica
                    const contaDebug = dadosProcessados.find(item => 
                        item.empresa === '3SA' && 
                        item.conta_corrente_descricao === 'Cart√£o - Caixinha - RH'
                    );
                    
                    if (contaDebug) {
                        console.log('‚úÖ Conta "Cart√£o - Caixinha - RH" ENCONTRADA!');
                        console.log('üí∞ Valor calculado:', contaDebug.valor_corrigido);
                        console.log('üìÖ At√© a data:', dataFiltro || 'sem filtro');
                    } else {
                        console.log('‚ùå Conta "Cart√£o - Caixinha - RH" N√ÉO ENCONTRADA');
                    }

                    setDados(dadosProcessados);

                    // Extrair empresas
                    const empresasUnicas = [...new Set(dadosProcessados.map(item => item.empresa))].sort();
                    // Empresas extra√≠das com sucesso
                    setEmpresas(empresasUnicas);

                    // Calcular estat√≠sticas
                    const somaTotal = dadosProcessados.reduce((acc, item) => acc + item.valor_corrigido, 0);
                    setStats({
                        totalEmpresas: empresasUnicas.length,
                        totalCombinacoes: dadosProcessados.length,
                        somaTotal: somaTotal
                    });

                    const endTime = window.performance.now();
                    const tempoCarregamento = endTime - startTime;
                    
                    setPerformance({
                        tempoCarregamento: tempoCarregamento,
                        metodo: dataFiltro ? 'view_com_filtro_data' : 'view_sem_filtro',
                        cacheAtualizado: new Date().toISOString()
                    });

                    console.log(`‚úÖ Dados carregados em ${tempoCarregamento.toFixed(2)}ms`);

                } catch (err) {
                    console.error('‚ùå Erro ao carregar dados:', err);
                    setError(err.message || 'Erro desconhecido');
                } finally {
                    setLoading(false);
                }
            };

            // ===============================================
            // FUN√á√ÉO ALTERNATIVA: USAR RESUMO SEM FILTRO
            // ===============================================
            const carregarResumoSemFiltro = async () => {
                const startTime = window.performance.now();
                try {
                    setLoading(true);
                    setError('');
                    console.log('üöÄ Carregando resumo SEM filtro de data...');

                    let query = supabase
                        .from('vw_dashboard_resumo')
                        .select(`
                            empresa,
                            conta_corrente_descricao,
                            saldo_inicial,
                            saldo_final,
                            qtd_movimentos,
                            primeira_movimentacao,
                            ultima_movimentacao
                        `);

                    // Aplicar filtro de empresa se n√£o for "TODAS"
                    if (empresaSelecionada && empresaSelecionada !== 'TODAS') {
                        query = query.eq('empresa', empresaSelecionada);
                    }

                    const { data: dadosResumo, error: errorResumo } = await query.order('saldo_final', { ascending: false });

                    if (errorResumo) throw errorResumo;

                    // Processar dados do resumo
                    const dadosProcessados = dadosResumo.map(item => ({
                        empresa: item.empresa,
                        conta_corrente_descricao: item.conta_corrente_descricao,
                        saldo_inicial: parseFloat(item.saldo_inicial || 0),
                        valor_corrigido: parseFloat(item.saldo_final || 0),
                        qtd_movimentos: parseInt(item.qtd_movimentos || 0),
                        primeira_movimentacao: item.primeira_movimentacao,
                        ultima_movimentacao: item.ultima_movimentacao
                    }));

                    setDados(dadosProcessados);

                    // Extrair empresas
                    const empresasUnicas = [...new Set(dadosProcessados.map(item => item.empresa))].sort();
                    // Empresas extra√≠das com sucesso
                    setEmpresas(empresasUnicas);

                    // Calcular estat√≠sticas
                    const somaTotal = dadosProcessados.reduce((acc, item) => acc + item.valor_corrigido, 0);
                    setStats({
                        totalEmpresas: empresasUnicas.length,
                        totalCombinacoes: dadosProcessados.length,
                        somaTotal: somaTotal
                    });

                    const endTime = window.performance.now();
                    const tempoCarregamento = endTime - startTime;
                    
                    setPerformance({
                        tempoCarregamento: tempoCarregamento,
                        metodo: 'view_dashboard_resumo',
                        cacheAtualizado: new Date().toISOString()
                    });

                    console.log(`‚úÖ Resumo carregado em ${tempoCarregamento.toFixed(2)}ms`);

                } catch (err) {
                    console.error('‚ùå Erro ao carregar resumo:', err);
                    setError(err.message || 'Erro desconhecido');
                } finally {
                    setLoading(false);
                }
            };

            // EFEITO PARA CARREGAR DADOS
            useEffect(() => {
                console.log('üîÑ useEffect disparado, dataFiltro:', dataFiltro);
                console.log('üìÖ Carregando dados usando vw_saldo_acumulado sempre');
                carregarDadosComFiltroData();
            }, [dataFiltro, empresaSelecionada]);

            // EFEITO INICIAL (removido - agora usa sempre vw_saldo_acumulado)

            // Aplicar filtros de busca
            const dadosFiltrados = dados.filter(item => {
                const passaFiltroBusca = busca === '' || 
                    item.empresa.toLowerCase().includes(busca.toLowerCase()) ||
                    item.conta_corrente_descricao.toLowerCase().includes(busca.toLowerCase());
                
                return passaFiltroBusca;
            });

            // Calcular estat√≠sticas filtradas
            const statsFiltradas = {
                totalEmpresas: empresaSelecionada === 'TODAS' ? 
                    new Set(dadosFiltrados.map(item => item.empresa)).size : 1,
                totalCombinacoes: dadosFiltrados.length,
                somaTotal: dadosFiltrados.reduce((acc, item) => acc + parseFloat(item.valor_corrigido || 0), 0)
            };

            const downloadCSV = () => {
                const dadosParaExport = dadosFiltrados.length > 0 ? dadosFiltrados : dados;
                const sufixoData = dataFiltro ? `_ate_${dataFiltro.replace(/-/g, '')}` : '';
                const nomeArquivo = empresaSelecionada === 'TODAS' ? 
                    `dashboard_omie_todas${sufixoData}.csv` : 
                    `dashboard_omie_${empresaSelecionada.replace(/\s+/g, '_')}${sufixoData}.csv`;
                
                const csvContent = [
                    'Empresa;Conta Corrente;Saldo Inicial;Valor Final;Qtd Movimentos',
                    ...dadosParaExport.map(item => 
                        `${item.empresa};${item.conta_corrente_descricao};${(item.saldo_inicial || 0).toFixed(2).replace('.', ',')};${item.valor_corrigido.toFixed(2).replace('.', ',')};${item.qtd_movimentos || 0}`
                    )
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nomeArquivo;
                link.click();
            };

            if (loading) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>Dashboard Omie</h1>
                            <p>Carregando dados com views corrigidas...</p>
                        </div>
                        <div className="main-card">
                            <div className="loading">
                                <div className="loading-spinner"></div>
                                <p>Usando views com l√≥gica de saldo acumulado correta...</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>Dashboard Omie</h1>
                            <p>Erro ao carregar dados</p>
                        </div>
                        <div className="main-card">
                            <div style={{background: '#fef2f2', border: '1px solid #fecaca', color: '#dc2626', padding: '20px', borderRadius: '12px', textAlign: 'center'}}>
                                <h3>Erro de Conex√£o</h3>
                                <p>{error}</p>
                                <button onClick={() => carregarDadosComFiltroData()} style={{marginTop: '15px', padding: '10px 20px', background: '#dc2626', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer'}}>
                                    Tentar Novamente
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <div className="header">
                        <h1>Dashboard Omie</h1>
                        <p>Saldo Acumulado por Conta Corrente</p>
                        <div className="performance-info">
                            <div className="perf-badge">
                                <i data-lucide="zap"></i>
                                {performance.tempoCarregamento.toFixed(1)}ms
                            </div>
                            <div className="perf-badge">
                                <i data-lucide="database"></i>
                                {performance.metodo}
                            </div>
                            <div className="perf-badge">
                                <i data-lucide="clock"></i>
                                {dataFiltro ? `At√© ${new Date(dataFiltro + 'T00:00:00').toLocaleDateString('pt-BR')}` : 'Sem filtro'}
                            </div>
                        </div>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-card-header">
                                <span className="stat-card-title">Total de Empresas</span>
                                <i data-lucide="building-2" className="stat-card-icon"></i>
                            </div>
                            <div className="stat-value">{formatNumber(statsFiltradas.totalEmpresas)}</div>
                            <div className="stat-label">
                                {empresaSelecionada === 'TODAS' ? 'Empresas ativas' : 'Empresa selecionada'}
                            </div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-card-header">
                                <span className="stat-card-title">Contas</span>
                                <i data-lucide="calculator" className="stat-card-icon"></i>
                            </div>
                            <div className="stat-value">{formatNumber(statsFiltradas.totalCombinacoes)}</div>
                            <div className="stat-label">Contas correntes</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-card-header">
                                <span className="stat-card-title">Saldo Total</span>
                                <i data-lucide="dollar-sign" className="stat-card-icon"></i>
                            </div>
                            <div className="stat-value">{formatCurrency(statsFiltradas.somaTotal)}</div>
                            <div className="stat-label">
                                {dataFiltro ? `Acumulado at√© ${new Date(dataFiltro + 'T00:00:00').toLocaleDateString('pt-BR')}` : 'Saldo atual'}
                            </div>
                        </div>
                    </div>

                    <div className="main-card">
                        <div className="filters-section">
                            <div className="filters-title">
                                <i data-lucide="filter"></i>
                                Filtrar por Empresa
                            </div>
                            <div className="filters-grid">
                                <button 
                                    className={`filter-btn ${empresaSelecionada === 'TODAS' ? 'all' : ''}`}
                                    onClick={() => setEmpresaSelecionada('TODAS')}
                                >
                                    Todas as Empresas
                                    <span className="filter-count">{formatNumber(stats.totalEmpresas)}</span>
                                </button>
                                {empresas.map(empresa => {
                                    const combinacoesEmpresa = dados.filter(item => item.empresa === empresa).length;
                                    return (
                                        <button
                                            key={empresa}
                                            className={`filter-btn ${empresaSelecionada === empresa ? 'active' : ''}`}
                                            onClick={() => setEmpresaSelecionada(empresa)}
                                        >
                                            {empresa}
                                            <span className="filter-count">{formatNumber(combinacoesEmpresa)}</span>
                                        </button>
                                    );
                                })}
                            </div>
                            
                            <div className="date-filter-container">
                                <div className="filters-title" style={{margin: 0}}>
                                    <i data-lucide="calendar"></i>
                                    Filtro por Data (Saldo Acumulado)
                                </div>
                                <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                                    <input
                                        type="date"
                                        className="date-input"
                                        defaultValue={dataFiltro}
                                        onBlur={(e) => {
                                            const novaData = e.target.value;
                                            if (novaData && novaData !== dataFiltro) {
                                                console.log('üìÖ Data confirmada:', novaData);
                                                setDataFiltro(novaData);
                                            }
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                const novaData = e.target.value;
                                                if (novaData) {
                                                    console.log('üìÖ Data confirmada com Enter:', novaData);
                                                    setDataFiltro(novaData);
                                                }
                                            }
                                        }}
                                        title="Escolha a data completa e pressione Enter ou clique fora para aplicar"
                                        placeholder="Selecione uma data"
                                    />
                                    <button 
                                        className="filter-btn"
                                        onClick={() => {
                                            const input = document.querySelector('input[type="date"]');
                                            const novaData = input.value;
                                            if (novaData && novaData !== dataFiltro) {
                                                console.log('üìÖ Data aplicada via bot√£o:', novaData);
                                                setDataFiltro(novaData);
                                            }
                                        }}
                                        style={{padding: '8px 16px', fontSize: '0.9rem'}}
                                        title="Aplicar filtro de data"
                                    >
                                        Aplicar
                                    </button>
                                </div>
                                {dataFiltro && (
                                    <button 
                                        className="clear-date-btn"
                                        onClick={() => setDataFiltro('')}
                                        title="Remover filtro de data"
                                    >
                                        <i data-lucide="x"></i>
                                        Limpar
                                    </button>
                                )}
                                {dataFiltro && (
                                    <span style={{color: '#059669', fontWeight: 500, fontSize: '0.9rem'}}>
                                        Saldo acumulado at√© {new Date(dataFiltro + 'T00:00:00').toLocaleDateString('pt-BR')}
                                    </span>
                                )}
                            </div>
                        </div>

                        <div className="card-header">
                            <h2 className="card-title">
                                Saldo por Conta
                                {empresaSelecionada !== 'TODAS' && (
                                    <span style={{color: '#667eea', fontWeight: 'normal', fontSize: '1rem'}}>
                                        ‚Üí {empresaSelecionada}
                                    </span>
                                )}
                            </h2>
                            
                            <div className="search-container">
                                <input
                                    type="text"
                                    className="search-input"
                                    placeholder="Buscar empresa ou conta..."
                                    value={busca}
                                    onChange={(e) => setBusca(e.target.value)}
                                />
                                <i data-lucide="search" className="search-icon"></i>
                            </div>
                            
                            <button className="export-btn" onClick={downloadCSV}>
                                <i data-lucide="download"></i>
                                Exportar CSV
                            </button>
                        </div>

                        <div className="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Empresa</th>
                                        <th>Conta Corrente</th>
                                        <th style={{textAlign: 'right'}}>Saldo Inicial</th>
                                        <th style={{textAlign: 'right'}}>Saldo {dataFiltro ? 'Acumulado' : 'Final'}</th>
                                        <th style={{textAlign: 'center'}}>Movimentos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {dadosFiltrados.map((item, index) => (
                                        <tr key={index}>
                                            <td className="empresa-cell">{item.empresa}</td>
                                            <td className="conta-cell">{item.conta_corrente_descricao}</td>
                                            <td style={{textAlign: 'right', fontFamily: 'monospace', color: '#6b7280'}}>
                                                {formatCurrency(item.saldo_inicial || 0)}
                                            </td>
                                            <td className={item.valor_corrigido >= 0 ? 'valor-positivo' : 'valor-negativo'} 
                                                style={{textAlign: 'right'}}>
                                                {formatCurrency(item.valor_corrigido)}
                                            </td>
                                            <td style={{textAlign: 'center', fontFamily: 'monospace', color: '#6b7280'}}>
                                                {item.qtd_movimentos || 0}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="footer-info">
                            Mostrando {dadosFiltrados.length} contas de {dados.length} totais
                            {empresaSelecionada !== 'TODAS' && ` ‚Ä¢ Empresa: ${empresaSelecionada}`}
                            {dataFiltro && ` ‚Ä¢ Saldo at√©: ${new Date(dataFiltro + 'T00:00:00').toLocaleDateString('pt-BR')}`}
                            {busca && ` ‚Ä¢ Busca: "${busca}"`}
                            ‚Ä¢ Carregado em {performance.tempoCarregamento.toFixed(1)}ms
                        </div>

                        <div className="debug-info">
                            ‚úÖ Sistema atualizado com views corretas! 
                            ‚Ä¢ Saldo acumulado calculado corretamente no SQL
                            ‚Ä¢ Performance otimizada com views especializadas
                            ‚Ä¢ L√≥gica de filtro de data implementada corretamente
                        </div>
                    </div>
                </div>
            );
        }

        // Renderizar o componente
        ReactDOM.render(<DashboardOmie />, document.getElementById('root'));
        
        // Inicializar √≠cones Lucide ap√≥s renderiza√ß√£o
        setTimeout(() => {
            if (window.lucide) {
                lucide.createIcons();
            }
        }, 100);
    </script>
</body>
</html>